var alertSigningFinish=false,jvmEnabled=false,skipLeavingPage=false,UNPROCESSABLE_ENTITY=422;function writeSUNJVMTags(){if(ePadSignSetting_js){if(isIEBrowser){detectJVM_IE()}else{jvmDetectionReturn(navigator.javaEnabled())}}if(jvmEnabled){if(isIEBrowser){$$("body").prepend('<object classid="clsid:E634B267-B8E7-406C-A308-988636B7D7E1" name="websignsup" width="0" height="0" codebase="/websignsup.cab#Version=7,1,0,1"><param name="useslibrary" value="websignsup"><param name="useslibrarycodebase" value="/websignsup.cab"><param name="useslibraryversion" value="7,1,0,1"></object><object classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93" name="Sign" width="0" height="0"><param name="code" value="integrisign.webclient.WebSign"><param name="archive" value="/websignsunjvm.jar?v=200406181300"></object>')}else{$$("body").prepend('<object classid="java:integrisign.webclient.WebSign.class" name="Sign" type="application/x-java-applet" archive="/websignsunjvm.jar?v=200406181300" width="0" height="0"></object>')}}}function detectJVM_IE(){$$("body").prepend('<object id="Status1" classid="clsid:64D90B4C-C486-455D-9FDB-37CED5C9C19C" width="0" height="0" codebase="/jvmdetect.cab#Version=7,1,0,0"><param name="useslibrary" value="JVMDetect"><param name="useslibrarycodebase" value="/jvmdetect.cab"><param name="useslibraryversion" value="7,1,0,0"></object>');var a=window.document.Status1.GetSUNPluginStatus();jvmDetectionReturn(a==0)}function jvmDetectionReturn(a){if(a){jvmEnabled=true}else{if(!manuallyDisableEpad_js){window.location=javaPluginHelpUrl}}}function checkAjaxResponse(a){if(a&&a.error&&a.error=="noaccess"){if(invitedByEmail){window.location="/web/pin?type=esign&id="+docId+"&access_key="+encodedKey+"&page="+pageNum}else{window.location="/web/signatures/"+docId+"/ceremony?page="+pageNum}}return a}var service=(function($){var svc={};svc.checkMissingSignaturePages=function(){return checkAjaxResponse(eval($.ajax({async:false,url:"/web/signatures/"+docId+"/missing_pages",data:{"selected_signer_ids[]":presentSignerIds,access_key:key}}).responseText))};svc.trackDocView=function(scrolledPercent){$.ajax({url:"/servlet/signatures/"+docId+"/page/"+currentPage+"/track_view",dataType:"json",data:{"selected_signer_ids[]":presentSignerIds,start_time:startTime.valueOf(),end_time:new Date().valueOf(),scrolled_percent:scrolledPercent,access_key:key},success:function(data){checkAjaxResponse(data)},error:function(xhr,errorType,exception){if(xhr.status===UNPROCESSABLE_ENTITY){skipLeavingPage=true;alert(t("signatures.document.we_could_not_generate_your_documents_for_signing_click_ok_to_log_in_and_generate_again"));checkAjaxResponse(JSON.parse(xhr.error().responseText))}}});startTime=new Date()};svc.signPDF=function(signerId,signatureId,signatureStr,signaturePaths,callback){var paramsData={signer_id:signerId,signature_id:signatureId,page_number:pageNum,access_key:key};paramsData[forgeryKey]=forgeryValue;if(signatureStr){paramsData.signature_str=signatureStr}else{if(signaturePaths&&signaturePaths.length>0){paramsData.signature_paths=$.map(signaturePaths,function(path){return $.map(path,function(point){return point.x+","+point.y}).join("|")}).join(" ")}}$.ajax({url:"/web/signatures/"+docId+"/sign",type:"POST",data:paramsData,dataType:"json",error:function(){callback(null)},success:function(data){callback(checkAjaxResponse(data))}})};svc.reauthenticate=function(password){var paramsData={password:password};paramsData[forgeryKey]=forgeryValue;var result=$.ajax({async:false,url:"/web/signatures/"+docId+"/reauthenticate",type:"POST",data:paramsData}).responseText;if(result=="true"){return true}$$("#password_invalid").html(result);return false};svc.leaveSigningProcess=function(){var result=$.ajax({async:false,url:"/web/signatures/"+docId+"/leaving_page",data:{"selected_signer_ids[]":presentSignerIds,access_key:key}}).responseText;updateDocumentViews();return eval(result)};return svc})(jQuery);function canSign(a){return signerInfo[signerIdFor(a)].present}function signerFor(a){return signerInfo[signerIdFor(a)]}function signerIdFor(a){if(a.signerId==0&&anonymousLandlordPresent){return mySignerId}return a.signerId}var sigsById={};var idCounter=0;function initSigIds(b){for(var e in sigsByPage){if(b&&b!=e){continue}var d=sigsByPage[e];var c=0;for(var a=0;a<d.length;a++){if(canSign(d[a])||(d[a].signed&&d[a].signed!="")){idCounter++;d[a].id="sig"+d[a].signatureId;sigsById[d[a].id]=d[a];c++}}}}var currentPage=-1;var startTime=new Date();var maxScrollTop=0;var leavingNormally=false;var unsignedPages=[];function getPrintLink(){var a="";if(invitedByEmail){a+="?access_key="+encodedKey}return"/web/signatures/"+docId+"/print"+a}function getUnviewedPages(){var b=[];for(var a=1;a<=totalPages;a++){if(viewedPagesMap[a]=="NONE"){b.push(a)}}return b}function leaveSigningProcess(){if(skipLeavingPage){return}var a=service.leaveSigningProcess();if(!leavingNormally){startTime=new Date();var d="";for(var c=0;c<a.length;c++){if(c==a.length-1){if(c>1){d+=" "+t("generic.and")+" "}d+=a[c]}else{d+=a[c]+", "}}if(d==""&&!viewAllPages_js){d=t("signatures.document.signatures_complete_save_and_print")}else{if(d!=""){if(a.length==1){d="This document has page "+d+" that has not been signed."}else{d="This document has pages "+d+" that have not been signed."}}}if(d!=""){return d}else{var b=getUnviewedPages();d="";for(var c=0;c<b.length;c++){if(c==b.length-1){if(c>1){d+=" "+t("generic.and")+" "}d+=b[c]}else{d+=b[c]+","}}if(d==""){d=t("signatures.document.signatures_complete_save_and_print")}else{if(b.length==1){d=t("signatures.document.this_document_has_page_pagenum_that_has_not_been_viewed",{pagenum:d})}else{d=t("signatures.document.this_document_has_pages_pagesnum_that_have_not_been_viewed",{pagesnum:d})}}return d}}}var moveMeAlertAndRedirect=function(){$$.bootbox("dialog",{closeButton:false,message:'<div style="text-align:center;"><img src="/images/icons/spinner.gif"></div>',noEscape:true,title:t("signatures.document.please_wait_as_we_finalize_your_documents"),});setTimeout(function(){window.location=MOVE_ME_REDIRECT},3000)};var showSignatureDialog=function(d,c){var a;if(c=="close"&&MOVE_ME_REDIRECT.length){return moveMeAlertAndRedirect()}var f=(function(h,g){if(h.length>1){return t("signatures.document.document_signatures_are_not_complete")}else{if(h.length==1){return t("signatures.document.document_signatures_are_not_complete")}else{return t("signatures.document.document_signatures_completed")}}}(d,c));var b=(function(m,j){var g="";if(m.length>1){g=t("signatures.document.document_has_pages_that_have_not_been_signed")+":"}else{if(m.length==1){g=t("signatures.document.document_has_page_that_has_not_been_signed")}else{g+=t("signatures.document.electronic_signatures_complete");g+=$$("#experimentOutput").html()}}g+="<p>";var l="";for(var h=0;h<m.length;h++){var k=m[h];l+="<a HREF='#TOC' onclick='goToPage("+k+")' >"+t("generic.page")+" "+k+"</a> &nbsp;"}g+=l;g+="</p>";return g}(d,c));var e=(function(h,g){var i={success:{className:"btn-primary",},danger:{className:"btn-link",label:t("generic.close"),callback:function(){a.modal("hide")},},};if(h.length==0){i.success.label=t("signatures.document.save_and_print_copy");i.success.callback=function(){parent.location=getPrintLink();a.modal("hide")}}else{if(g=="lease_details"&&!window.viewAllPages_js){i.success.label=t("generic.go_to")+" "+t("leasing.lease_details");i.success.callback=function(){if(window.relogin_js){reloginAlert("/web/lease?lease_id="+window.leaseId)}else{parent.location="/web/lease?lease_id="+window.leaseId}}}if(g=="leasing_activity"&&!window.viewAllPages_js){i.success.label=t("generic.go_to")+" "+t("leasing.recent_leasing_activity");i.success.callback=function(){if(window.relogin_js){reloginAlert("/web/leases")}else{parent.location="/web/leases"}}}if(g=="print"&&!window.viewAllPages_js){i.success.label=t("pin.esign.continue_to_print");i.success.callback=function(){if(!window.invitedByEmail&&window.relogin_js){reloginAlert(getPrintLink())}else{parent.location=getPrintLink()}}}if(g=="close"){i.success.label=t("signatures.document.save_and_print_copy");i.success.callback=function(){parent.location=getPrintLink()}}if(window.viewAllPages_js&&g!=="close"){delete i.success}}if(g=="close"){i.danger.callback=function(){parent.location="/web/signatures/goodbye?locale="+I18n.locale+"&signer_name="+encodedSignerNames+"&property_name="+encodedPropertyName;a.modal("hide")}}return i}(d,c));a=$$.bootbox("dialog",b,null,{title:f,buttons:e,})};var showUnviewedPagesDialog=function(b){var a;var d=t("signatures.document.not_all_document_pages_have_been_viewed");var c=(function(f){var g="";var j="";if(f.length>1){g+=t("signatures.document.this_document_has_pages_that_have_not_been_viewed")+":"}else{if(f.length==1){g+=t("signatures.document.this_document_has_a_page_that_has_not_been_viewed")}}g+="<p>";for(var e=0;e<f.length;e++){var h=f[e];j+="<a HREF='#TOC' onclick='goToPage("+h+")' >"+t("generic.page")+" "+h+"</a> &nbsp;"}g+=j;g+="</p>";return g}(b));a=$$.bootbox("dialog",c,null,{title:d,buttons:{close:{className:"btn-link",callback:function(){a.modal("hide")}}},})};function goToLeasePage(b){updateDocumentViews();leavingNormally=true;unsignedPages=service.checkMissingSignaturePages();var a=getUnviewedPages();if((unsignedPages==null||unsignedPages.length==0)&&(!viewAllPages_js||(a==null||a.length==0))){if(b=="lease_details"){if(relogin_js){reloginAlert("/web/lease?lease_id="+leaseId)}else{parent.location="/web/lease?lease_id="+leaseId}return}else{if(b=="leasing_activity"){if(relogin_js){reloginAlert("/web/leases")}else{parent.location="/web/leases"}return}else{if(b=="print"){if(!invitedByEmail&&relogin_js){reloginAlert(getPrintLink())}else{parent.location=getPrintLink()}return}}}}if(unsignedPages.length>=1||((!viewAllPages_js||(a==null||a.length==0))&&b=="close")){showSignatureDialog(unsignedPages,b)}if(a.length>=1){showUnviewedPagesDialog(a)}}function hideAlert(){leavingNormally=false;$("theLayer").style.visibility="hidden";$("bounceGrey").style.visibility="hidden"}function goToPage(a){hideAlert();shiftDocPage(a)}function startScrollingDetector(){setInterval("scrollingDetector()",250)}function getScrollTop(){if(isTouchDevice){return $$(window).height()-$$("#pagecontainer").position().top+$$(window).scrollTop()-($$("#pagecontainer").innerHeight()-$$("#pagecontainer").height())/2}return $$("#pagecontainer").scrollTop()+$$("#pagecontainer").innerHeight()}function showSigningFinishedAlert(){var a=t("signatures.document.thank_you_please_invite_your_guarantor");if(alertSigningFinish){return}alertSigningFinish=true;if(inviteGuarantorWhenComplete){$$("#inviteDialog").dialog({title:a,width:550,buttons:[{"class":"btn btn-primary applicant-invite-button",text:t("generic.send_invitation"),click:function(){$$(this).find("#invite_form").trigger("submit")}},{"class":"btn btn-link cancel-button",click:function(){OSM.util.showDialog("cancel");$$(this).dialog("close")},text:t("generic.cancel")}]});$$("#cancelDialog").dialog("option","width",550);OSM.util.showDialog("invite")}else{goToLeasePage("close")}}function scrollingDetector(){if(maxScrollTop<getScrollTop()){maxScrollTop=getScrollTop()}updateDocumentViewsIfFullyScrolled();if(viewAllPages_js){var a=getUnviewedPages();if(allSigned()&&(a!=null&&(a.length==0||(a.length==1&&a[0]==currentPage)))){if(maxScrollTop>1154){showSigningFinishedAlert()}}}else{if(allSigned()){showSigningFinishedAlert()}}}var fullyScrolled={};function updateDocumentViewsIfFullyScrolled(){if(currentPage==-1){return}if(fullyScrolled[currentPage]||viewedPagesMap[currentPage]=="COMPLETE"||signatureStatus(currentPage)!="COMPLETE"){return}var a=maxScrollTop/$$("#page").height();if(a<0.99){return}fullyScrolled[currentPage]=true;updateDocumentViews()}function updateDocumentViews(){if(currentPage==-1){return}var b=maxScrollTop/$$("#page").height();service.trackDocView(b);if(b>0.85){var a=signatureStatus(currentPage);if(a=="COMPLETE"){viewedPagesMap[currentPage]="COMPLETE"}else{viewedPagesMap[currentPage]="PARTIAL"}}else{if(viewedPagesMap[currentPage]=="NONE"){viewedPagesMap[currentPage]="PARTIAL"}}updateClassFor(currentPage);maxScrollTop=0}function signatureCountFor(e){var a={required:0,signed:0};var d=sigsByPage["p"+e];if(!d){return a}for(var c=0;c<d.length;c++){var f=d[c];if(canSign(f)){a.required++;var b=f.signedDate||"";if(b!=""){a.signed++}}}return a}function signatureStatus(b){var a=signatureCountFor(b);if(a.required==0||a.required==a.signed){return"COMPLETE"}if(a.signed==0){return"NONE"}return"PARTIAL"}function sealClassFor(b){var a=signatureCountFor(b);if(a.required==0){return""}if(a.required==a.signed){return"complete_seal"}return"partial_seal"}function loadImageAsBG(b,f){var c=$$("#page");var e="normal";if(c.queue().length>0){e="fast"}var a=$$("#thumblink"+b).attr("bigImage");var d=function(){var h=new Image();c.addClass("waiting").css("background-image","").attr("imagePath",a).attr("pageNumber",b);highlightFields(0);if(!a){return}var g=$$(h);c.css("background-image","url("+c.attr("imagePath")+")");g.on("load",function(){c.removeClass("waiting");$$("#page").width(h.width);$$("#page").height(h.height);highlightFields(c.attr("pageNumber"))});g.attr("src",a)};if(f=="none"){return d()}c.hide("slide",{direction:f},e,function(){d()});if(f=="right"){f="left"}else{f="right"}c.show("slide",{direction:f},e)}function shiftDocPage(a){if(a>totalPages||a<=0||currentPage==a){return}var b="right";if(currentPage<1){b="none"}else{if(currentPage<a){b="left"}}updateDocumentViews();currentPage=a;pageNum=a;startTime=new Date();$$("#pageNumber").html(a);$("pagecontainer").scrollTop="0px";loadImageAsBG(a,b);window.location.hash=""+a;$$(".thumblink").css({opacity:0.75}).removeClass("selectedThumb");$$("#thumblink"+pageNum).stop(true,true).css({opacity:1}).addClass("selectedThumb");updateDocumentViews();setTimeout(function(){$$("#pagecontainer").scrollTop(0)},250)}function gotoPreviousPage(){shiftDocPage(pageNum-1);return false}function gotoNextPage(){shiftDocPage(pageNum+1);return false}function updateClassFor(b){var a=$$("#seal"+b);var c=$$("#thumb"+b);c.removeClass("partial_checked checked");if(viewedPagesMap[b]=="PARTIAL"){c.addClass("partial_checked")}else{if(viewedPagesMap[b]=="COMPLETE"){c.addClass("checked")}}a.removeClass("partial_seal complete_seal");a.addClass(sealClassFor(b))}var swipeEnabled=false;function enableSwipe(){if(swipeEnabled){return}$$("#page").on("swipeleft",gotoNextPage);$$("#page").on("swiperight",gotoPreviousPage);swipeEnabled=true}function disableSwipe(){if(!swipeEnabled){return}$$("#page").off("swipeleft",gotoNextPage);$$("#page").off("swiperight",gotoPreviousPage);swipeEnabled=false}function setDocSize(){if($$(".signhelp").height()>50){$$(".signhelp").width($$("#nav-frame").width()-16)}var d=$$(window).height();var c=$$("#pagenav").height();var b=$$("#pagecontainer");var a=b.offset().top;if(isTouchDevice){b.css({height:$$("#page").height()+"px"})}else{b.css({height:(d-a+2)+"px"})}}function checkZoomLevel(){if(!window.innerWidth){return}if($$(window).width()>window.innerWidth){disableSwipe()}else{enableSwipe()}}function highlightFields(a){$$("#page").find(".ePadSign, .initial, .initialHL, .signature, .compact-signature, .signed, .signed-compact").remove();var b=sigsByPage["p"+a];if(b==null){return}$$.each(b,function(c,e){if(signerInfo[e.signerId]){var d=createSignature(e);if(d){$$("#page").append(d)}}})}function updateSignatureImg(b,a,e){var d=sigsByPage["p"+b];if(d==null){return}for(var c=0;c<d.length;c++){if(d[c].signatureId==a){d[c].sigImg=e}}}function createSignature(a){var c;var h=signerFor(a);if(a.signed&&a.signed!=""){if(a.initial=="y"){if(a.sigImg!=""){c=$$('<div id="'+a.id+'" class="ePadSign initials_signature"><img src="/web/signatures/'+docId+"/image.png?sig_id="+a.signatureId+"&access_key="+encodedKey+'" /></div>')}else{c=$$('<div id="'+a.id+'" class="initial"><div class="name">'+a.initialName+'</div><div class="key">'+h.key+"</div></div>")}}else{var g=a.newSigned?remoteAddr:a.ipAddress;if(a.sigImg!=""){c=$$('<div id="'+a.id+'" class="ePadSign normal_signature'+(a.initial=="c"?" compactSigImage":"")+'"><div><div class="leftS"><img src="/web/signatures/'+docId+"/image.png?sig_id="+a.signatureId+"&access_key="+encodedKey+'" /></div><div class="rightS"><div class="date">'+a.signedDate+'</div><div class="time">'+a.signedTime+"</div></div></div></div>")}else{var f="signed";if(a.initial=="c"){f+="-compact"}if(a.signerName.length<25){c=$$('<div id="'+a.id+'" class="'+f+'"><div class="first">Signed by '+a.signerName+'</div><div class="date">'+a.signed+'</div><div class="detail">Key: '+h.key+"; IP Address: "+g+"</div></div>")}else{var b="Signed by ";if(a.initial=="c"){b=""}c=$$('<div id="'+a.id+'" class="'+f+'"><div class="small_first">'+b+a.signerName+"</div><div>"+a.signed+"</div><div>Key: "+h.key+"; IP Address: "+g+"</div></div>")}}}}else{if(canSign(a)){var e="signature";if(a.initial=="y"){e="initialHL"}else{if(a.initial=="c"){e="compact-signature"}}c=$$('<a id="'+a.id+'" class="'+e+'" href="#"></a>');c.click(function(){sign(a.id);return false});c.css({opacity:0.5,zIndex:10})}}if(!c){return}c.css({position:"absolute",left:a.x+"px",top:a.y+"px"});var d=signatureDimensions(a);c.find("img").each(function(){$$(this).load(function(){var m=$$(this);var k=m.width();var i=m.height();var l=k*d.desiredHeight/i;var j=d.desiredHeight;if(l>d.maxWidth){l=d.maxWidth;j=i*d.maxWidth/k}m.width(Math.floor(l));m.height(Math.floor(j))})});return c}function signatureDimensions(a){if(a.initial=="y"){return{desiredHeight:INITIALS_SIGNATURE_HEIGHT,maxWidth:INITIALS_SIGNATURE_WIDTH}}else{if(a.initial=="c"){return{desiredHeight:COMPACT_SIGNATURE_HEIGHT,maxWidth:COMPACT_SIGNATURE_WIDTH}}else{return{desiredHeight:NORMAL_SIGNATURE_HEIGHT,maxWidth:NORMAL_SIGNATURE_WIDTH}}}}var rememberSignatureChoice={};function sign(c){var i;var f;var d;var g;var e=sigsById[c];var h=""+signerIdFor(e)+(e.initial=="y"?"y":"");var b=signerFor(e);var a=function(){$$("#"+e.id).addClass("waiting");signConfirmed(e,d,g)};var k=function(){var l=$$(this);if(ePadSign_js){return}if(!useFingerSign){a();l.modal("hide");return}if(f.find(".signaturebox").signaturebox("getsignaturelength")<MINIMUM_SIGNATURE_PATH_LENGTH){alert("Please make your signature a little longer before saving.");return false}g=f.find(".signaturebox").signaturebox("getpaths");l.modal("hide");if(g&&g.length>0){if(f.find(".rememberSignature").is(":checked")){rememberSignatureChoice[h]=true;f.find(".signaturebox").signaturebox("save",h)}a()}};if(ePadSign_js){document.Sign.signNowEx(e.signatureId,b.name,"","","","",false);if(document.Sign.getString()==null){return}d=document.Sign.getPNGString(document.Sign.getString(),228,168,true)+"";return a()}if(e.initial=="y"){i=initialModalOptions(b);f=$$("#initialbox")}else{i=signatureModalOptions(b);f=$$("#signbox")}i.buttons={sign:{callback:k,className:"btn btn-primary okClickSignature",label:t("generic.sign"),},cancel:{callback:function(){$$(this).modal("hide")},className:"btn btn-link cancelSignature",label:t("generic.cancel"),}};f.find(".handsignature").toggleClass("hidden",!useFingerSign);f.find(".signaturebox").signaturebox("clear");f.find(".rememberSignature").prop("checked",rememberSignatureChoice[h]!==false);f.find(".signaturebox").signaturebox("load",h);f.find(".signerInitials").html(b.initials);f.find(".signerName").html(b.name);var j=f.find(".sign_style");if(j.data("mode")==="hidden"){j.hide();updateSignStyle(j)}else{f.find(".sign_style").show()}f.show();$$.bootbox("dialog",f,null,i).on("shown.bs.modal",function(){$$("button.okClickSignature").focus()}).on("hide.bs.modal",function(){if(!f.find(".rememberSignature").is(":checked")){rememberSignatureChoice[h]=false;f.find(".signaturebox").signaturebox("forget",h)}f.hide().appendTo("body")})}function signConfirmed(b,f,d){var c=pageNum;b.newSigned=true;var a=signerIdFor(b);var e=signerInfo[a];service.signPDF(a,b.signatureId,f,d,function(h){if(f){updateSignatureImg(c,b.signatureId,f)}else{if(d&&d.length>0){updateSignatureImg(c,b.signatureId,"signed")}}if(h==null){alert(t("signatures.document.whoops_failed_to_sign_the_document_please_sign_it_later"));$$("#"+b.id).removeClass("waiting");return}b.signed=h[0];b.signedDate=h[1];b.signedTime=h[2];b.signerName=e.name;b.initialName=e.initials;updateClassFor(pageNum);var j=createSignature(b);var i=j.find("img");var g=function(){$$("#"+b.id).after(j);$$("#"+b.id).remove()};if(i.size()>0){var k=new Image();$$(k).load(g).prop("src",i.prop("src"))}else{g()}if(allSigned()){$$("#sign_without_epad").hide()}})}function allSigned(){for(var b in sigsById){var a=sigsById[b];if(a.signed==""){return false}}return true}function docFinished(){removeElement("thumbs");removeElement("pagenav");removeElement("pagecontainer");removeElement("ePadbt")}function reloginAlert(a){$$("#exit_password").val("");OSM.util.showDialog("signRelogin");$$("#exit_password").focus();nextPage=a}function reauthenticate(){var a=service.reauthenticate($$("#exit_password").val());if(a){skipLeavingPage=true;parent.location=nextPage}else{$$("#password_invalid").removeClass("nodisplay")}}var UPDATE_PAGES_INTERVAL=3000;function updateThumbBackground(a,c,f){f=f||1;var d=200*f;var g=c;if(f>1){g=c+"?count="+f}if(d>2000){d=2000}var e=new Image();var b=function(){window.setTimeout(function(){updateThumbBackground(a,c,f+1)},d)};$$(e).on("error",b).on("load",function(){if(this.width<10||this.height<10){b()}else{a.css("background-image","url("+g+")");a.removeClass("thumb_waiting").find("img").remove()}}).prop("src",g)}function isPageReady(b){var a=$$("#thumblink"+b).attr("bigImage");return a!==null&&a!==undefined&&a!==""}function getMissingPages(){var a=[];for(var c=1;c<=totalPages;c++){var b=$$("#thumblink"+c).attr("bigImage");if(!isPageReady(c)){a.push(c)}}return a}function updatePages(){$$.ajax({url:"/web/signatures/"+docId+"/generated_pages",data:{missing:getMissingPages(),access_key:key},dataType:"json",success:function(a){checkAjaxResponse(a);$$.each(a.signatures,function(c,b){sigsByPage[c]=b;initSigIds(c)});$$.each(a.images,function(c,e){var d=parseInt(c,10);if(!isPageReady(d)){var b=$$("#thumblink"+d);b.attr("bigImage",e.big);updateThumbBackground(b,e.thumbnail);b.fadeIn(2000);if(currentPage===d){currentPage=-1;shiftDocPage(d)}}});if(getMissingPages().length>0){window.setTimeout(updatePages,UPDATE_PAGES_INTERVAL)}},error:function(c,b,a){if(c.status===UNPROCESSABLE_ENTITY){skipLeavingPage=true;alert(t("signatures.document.we_could_not_generate_your_documents_for_signing_click_ok_to_log_in_and_generate_again"));checkAjaxResponse(JSON.parse(c.error().responseText))}else{window.setTimeout(updatePages,UPDATE_PAGES_INTERVAL)}}})}function setCurrentPage(){if(window.location.hash&&/^#?\d+$/.test(window.location.hash)){pageNum=parseInt(window.location.hash.replace(/#/,""),10)}shiftDocPage(pageNum)}var isIEBrowser;var setupThankYouDialog=function(){$$("#thanksDialog").dialog({title:t("generic.thank_you!"),width:550,buttons:[{"class":"btn btn-primary save-and-print-copy-button",click:function(){window.location=getPrintLink()},text:t("signatures.document.save_and_print_copy")},{"class":"btn btn-link close-thank-you-dialog",click:function(){$$(this).dialog("close")},text:t("generic.close")}]})};var sendInviteRequest=function(){$$.ajax({type:"POST",url:"/web/signatures/"+docId+"/invite_guarantor",data:{"selected_signer_ids[]":presentSignerIds,access_key:key,email_address:$$("#invite_form input[name='email_address']").val(),first_name:$$("#invite_form input[name='first_name']").val(),last_name:$$("#invite_form input[name='last_name']").val()},dataType:"json",success:function(a){$$("#invite_spinner").hide();OSM.util.hideDialog("invite");OSM.util.showDialog("thanks");$$("#invite_form input[name='email_address']").val("").blur();$$("#invite_form input[name='first_name']").val("").blur();$$("#invite_form input[name='last_name']").val("").blur()},error:function(){alert(t("signatures.document.there_was_an_error_sending_your_invitation"))}});$$("#invite_spinner, #spinner_container").show();$$("#inviteDialog .contents, #inviteDialog .invite_header").hide()};var signatureModalOptions=function(b){var a=t("signatures.document.you_are_about_to_electronically_sign_this_page_as")+' <span class="signerName">'+b.name+"</span>. ";return{title:a,className:"signaturebox-modal",}};var initialModalOptions=function(b){var a=t("signatures.document.initials_for")+' <span class="signerName">'+b.name+"</span>";return{title:a,className:"initialbox-modal",}};jQuery(function(c){var d=c("#invite_form");isIEBrowser=OSM.util.isMSIE();if(isIEBrowser){c("body").addClass("msie")}writeSUNJVMTags();initSigIds();setCurrentPage();setDocSize();startScrollingDetector();setupThankYouDialog();c(window).resize(setDocSize);c.createPropertyChangeEvent("changehash",window.location,"hash");c(window.location).bind("changehash",function(e,f){if(f&&/^#?\d+$/.test(f)){shiftDocPage(parseInt(f.replace(/#/,""),10))}});c(".signaturebox").signaturebox();c(".clearSignature").click(function(){c(this).parents(".signaturedialog").find(".signaturebox").signaturebox("clear");return false});c(".undoSignature").click(function(){c(this).parents(".signaturedialog").find(".signaturebox").signaturebox("undo");return false});c(".cancelSignature").click(function(){c(this).parents(".signaturedialog").dialog("close")});c(".signaturedialog").parents(".ui-dialog").find(".ui-dialog-titlebar").addClass("signdialog-titlebar");c("#reloginForm").submit(function(){reauthenticate();return false});c(".goto_lease_activity").click(function(){goToLeasePage("leasing_activity");return false});c(".goto_lease_details").click(function(){goToLeasePage("lease_details");return false});c(document).on("click",".goto_lease_print",function(){goToLeasePage("print");return false});c(".goto_lease_close").click(function(){goToLeasePage("close");return false});c(".goto_specific_page").click(function(){shiftDocPage(parseInt(c(this).attr("pagenumber"),10));return false});c(".goto_previous_page").click(gotoPreviousPage);c(".goto_next_page").click(gotoNextPage);c("body").keydown(function(f){if(f.keyCode==37){return gotoPreviousPage()}else{if(f.keyCode==39){return gotoNextPage()}}});c.swipeOptions.maxVertical=50;c.swipeOptions.minHorizontal=150;checkZoomLevel();if(window.innerWidth){c.createPropertyChangeEvent("changezoomx",window,"innerWidth");c(window).bind("changezoomx",checkZoomLevel)}updateSignStyle=function(f){useFingerSign=parseInt(f.val())==1;c(".sign_style").val(f.val());var e=f.parents(".signaturedialog").parent();e.find(".handsignature").toggleClass("hidden",!useFingerSign)};c(".sign_style").change(function(){updateSignStyle(c(this))});for(var b=1;b<=totalPages;b++){c("#seal"+b).addClass(sealClassFor(b))}c(".replace_thumb").each(function(){var e=c(this);updateThumbBackground(e,e.attr("replaceThumbUrl"))});if(getMissingPages().length>0){window.setTimeout(updatePages,UPDATE_PAGES_INTERVAL)}window.onbeforeunload=leaveSigningProcess;c.guards.defaults.tag="div";c.guards.defaults.messageClass="hot";c.guards.defaults.invalidClass="hilight";d.enableGuards();c.guard("#invite_form input[name=email_address]").using("email");c.guard("#invite_form input[name=first_name]").using("required").message("First name is required.");c.guard("#invite_form input[name=last_name]").using("required").message("Last name is required.");c.guard("#invite_form input[name=email_address]").using("required").message("Email is required.");if(c("#invite_form input[name='email_address']").size()>0){var a=c("#invite_form input[name='email_address']").data("tenant-email-addresses").split(" ");c.guard("#invite_form input[name=email_address]").using("disallow",a).message("Email address is already in use.")}d.on("submit",function(e){e.preventDefault();if(d.guard()){sendInviteRequest()}});c("#cancel_form #choose_guarantor").click(function(){OSM.util.hideDialog("cancel")});c("#cancel_form .cancelButton").click(function(){OSM.util.hideDialog("cancel");OSM.util.hideDialog("invite")})});
