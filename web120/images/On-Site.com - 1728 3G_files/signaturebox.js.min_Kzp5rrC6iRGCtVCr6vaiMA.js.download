(function(e){function b(l,m,k){this.paper=Raphael(l,m,k)}b.prototype.line=function(k,l){return new g(this.paper,k,l)};b.prototype.clear=function(){this.paper.clear()};function g(l,k,m){this.paper=l;this.points=1;this.startX=k;this.startY=m;this.text="M"+k+" "+m;this.object=l.path(this.text);this.object.attr("stroke","black")}g.prototype.addPoint=function(k,l){this.points+=1;this.text+="L"+k+" "+l;this.object.attr("path",this.text)};g.prototype.finish=function(){if(this.points==1){this.object.remove();this.object=this.paper.circle(this.startX,this.startY,1);this.object.attr("stroke","black");this.object.attr("fill","black")}};g.prototype.remove=function(){this.object.remove()};function d(l,m,k){var n=e('<canvas width="'+m+'" height="'+k+'"></canvas>');e(l).append(n);this.canvas=n[0];this.context=this.canvas.getContext("2d");this.context.strokeStyle="rgb(0, 0, 0)";this.context.fillStyle="rgb(0, 0, 0)";this.lines=[]}d.prototype.line=function(k,m){var l=new c(this,k,m);this.lines.push(l);return l};d.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);while(this.lines.length>0){this.lines.pop()}};d.prototype.redraw=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var k=0;k<this.lines.length;k++){this.lines[k].redraw()}};function c(m,k,l){this.canvasSignature=m;this.points=[{x:k,y:l}]}c.prototype.addPoint=function(k,l){this.points.push({x:k,y:l});this.canvasSignature.redraw()};c.prototype.finish=function(){if(this.points.length==1){this.canvasSignature.context.fillRect(this.points[0].x,this.points[0].y,1,1)}};c.prototype.remove=function(){var k=e.inArray(this,this.canvasSignature.lines);if(k<0){return}this.canvasSignature.lines.splice(k,1);this.canvasSignature.redraw()};c.prototype.redraw=function(){if(this.points==1){this.canvasSignature.context.fillRect(this.points[0].x,this.points[0].y,1,1)}else{this.canvasSignature.context.beginPath();this.canvasSignature.context.moveTo(this.points[0].x,this.points[0].y);for(var k=1;k<this.points.length;k++){this.canvasSignature.context.lineTo(this.points[k].x,this.points[k].y)}this.canvasSignature.context.stroke()}};function j(k){var l=k;if(l.originalEvent.touches&&l.originalEvent.touches[0]){l=l.originalEvent.touches[0]}return l}function i(k){if(k.originalEvent.touches){return k.originalEvent.touches.length}return 1}function f(l,k,m){this.points=[{x:k,y:m}];this.object=l.line(k,m)}f.prototype.addPoint=function(k,l){this.points.push({x:k,y:l});this.object.addPoint(k,l)};f.prototype.finish=function(){this.object.finish()};function h(n){this.saves={};var s=e(n);var l=0;if(s.css("width").indexOf("%")>0){l=window.innerWidth-10;var q=s.css("max-width").replace(/px/,"");if(l>q){l=q}}else{l=s.width()||s.css("width").replace(/px/,"")}var t=s.height()||s.css("height").replace(/px/,"");var r=0;try{this.signaturecanvas=new b(n,l,t)}catch(o){this.signaturecanvas=new d(n,l,t)}var m=function(v){return Math.min(l,Math.max(0,v-s.offset().left))};var k=function(v){return Math.min(t,Math.max(0,v-s.offset().top+r))};this.signaturepaths=[];var u=this;var p=function(v,x,w){return function(A){if(i(A)>1){return}if(w&&A.which!=1){e(document).unbind(v).unbind(x);return}A=j(A);if(A.pageY-s.offset().top<0){r=e(window).scrollTop()}var z=u.startPath(m(A.pageX),k(A.pageY));var y=function(B){B=j(B);z.addPoint(m(B.pageX),k(B.pageY));return false};e(document).bind(v,y).bind(x,function(B){e(document).unbind(v).unbind(x);z.finish();return false});return false}};s.bind("mousedown",p("mousemove.signaturebox","mouseup.signaturebox",true));s.bind("touchstart",p("touchmove.signaturebox","touchend.signaturebox touchcancel.signaturebox",false))}h.prototype.startPath=function(k,m){var l=new f(this.signaturecanvas,k,m);this.signaturepaths.push(l);return l};h.prototype.undo=function(){if(this.signaturepaths.length==0){return}this.signaturepaths.pop().object.remove()};function a(n,m){var l=m.x-n.x;var k=m.y-n.y;return Math.sqrt(l*l+k*k)}h.prototype.getSignatureLength=function(){var m=0;for(var l=0;l<this.signaturepaths.length;l++){var o=this.signaturepaths[l];var n=o.points[0];for(var k=1;k<o.points.length;k++){m+=a(n,o.points[k]);n=o.points[k]}}return m};h.prototype.clear=function(){this.signaturecanvas.clear();while(this.signaturepaths.length>0){this.signaturepaths.pop()}};h.prototype.getPaths=function(){var l=[];for(var k=0;k<this.signaturepaths.length;k++){l.push(e.map(this.signaturepaths[k].points,function(m){return{x:m.x,y:m.y}}))}return l};h.prototype.save=function(k){this.saves[k]=this.getPaths()};h.prototype.forget=function(k){this.saves[k]=null};h.prototype.load=function(o){this.clear();var n=this.saves[o];if(n){for(var l=0;l<n.length;l++){var m=this.startPath(n[l][0].x,n[l][0].y);for(var k=1;k<n[l].length;k++){m.addPoint(n[l][k].x,n[l][k].y)}m.finish()}}};e.fn.signaturebox=function(l,k){if(l=="undo"){if(!this.signaturebox){return this}return this.each(function(){this.signaturebox.undo()})}if(l=="getsignaturelength"){if(!this[0].signaturebox){return}return this[0].signaturebox.getSignatureLength()}if(l=="clear"){if(!this.signaturebox){return this}return this.each(function(){this.signaturebox.clear()})}if(l=="getpaths"){if(!this[0].signaturebox){return}return this[0].signaturebox.getPaths()}if(l=="save"){if(!this.signaturebox){return this}return this.each(function(){this.signaturebox.save(k)})}if(l=="forget"){if(!this.signaturebox){return this}return this.each(function(){this.signaturebox.forget(k)})}if(l=="load"){if(!this.signaturebox){return this}return this.each(function(){this.signaturebox.load(k)})}return this.each(function(){if(this.signaturebox){return}this.signaturebox=new h(this)})}})(jQuery);
